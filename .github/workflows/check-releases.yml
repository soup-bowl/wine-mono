name: Check for New Mono Releases

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for New Releases
        id: check-releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RSS_FEED_URL: "https://gitlab.winehq.org/mono/mono/-/releases.atom"
          # Configuration: Customize the issue message template
          ISSUE_TITLE_TEMPLATE: "New Mono Release: {version}"
          ISSUE_BODY_TEMPLATE: |
            A new release of Mono has been detected from the WineHQ GitLab repository.
            
            **Release Version:** {version}
            **Release Date:** {date}
            **Release URL:** {url}
            
            Please review and consider updating the Dockerfile to support this new version.
          # Configuration: Customize issue labels (comma-separated)
          ISSUE_LABELS: "enhancement,upstream-release"
          # Configuration: Maximum number of releases to process in a single run
          MAX_RELEASES: "20"
        run: |
          #!/bin/bash
          set -e
          
          echo "Fetching RSS feed from: $RSS_FEED_URL"
          
          # Fetch the RSS feed with error handling
          if ! RSS_CONTENT=$(curl -sSL --fail "$RSS_FEED_URL" 2>&1); then
            echo "Error: Failed to fetch RSS feed from $RSS_FEED_URL"
            echo "Curl error: $RSS_CONTENT"
            exit 1
          fi
          
          if [ -z "$RSS_CONTENT" ]; then
            echo "Error: RSS feed is empty"
            exit 1
          fi
          
          # Create a directory to store notified releases if it doesn't exist
          mkdir -p .github/notified-releases
          NOTIFIED_FILE=".github/notified-releases/releases.txt"
          
          # Initialize the notified releases file if it doesn't exist
          if [ ! -f "$NOTIFIED_FILE" ]; then
            touch "$NOTIFIED_FILE"
          fi
          
          # Configure git for potential commits
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Parse the RSS feed and collect new releases
          # Using a temporary file to avoid subshell variable issues
          TEMP_RELEASES=$(mktemp)
          
          # Parse the RSS feed to extract release information
          # Convert to single line per entry for easier parsing
          while IFS= read -r entry; do
            # Extract title (version)
            TITLE=$(echo "$entry" | sed -n 's/.*<title>\([^<]*\)<\/title>.*/\1/p')
            # Extract link (URL)
            LINK=$(echo "$entry" | sed -n 's/.*<link href="\([^"]*\)".*/\1/p')
            # Extract published date
            DATE=$(echo "$entry" | sed -n 's/.*<published>\([^<]*\)<\/published>.*/\1/p')
            
            # Validate that we successfully extracted required fields
            if [ -z "$TITLE" ]; then
              echo "Warning: Skipping entry with missing title"
              continue
            fi
            
            if [ -z "$LINK" ]; then
              echo "Warning: Release $TITLE has no link, using placeholder"
              LINK="(no link available)"
            fi
            
            if [ -z "$DATE" ]; then
              echo "Warning: Release $TITLE has no date, using placeholder"
              DATE="(date not available)"
            fi
            
            echo "Found release: $TITLE"
            
            # Check if this release has already been notified
            if grep -Fxq "$TITLE" "$NOTIFIED_FILE"; then
              echo "Release $TITLE already notified, skipping"
              continue
            fi
            
            echo "New release detected: $TITLE"
            
            # Save new release information to temp file
            echo "$TITLE|$LINK|$DATE" >> "$TEMP_RELEASES"
          done < <(echo "$RSS_CONTENT" | tr '\n' ' ' | sed 's/<entry>/\n<entry>/g' | grep '<entry>' | head -n "$MAX_RELEASES")
          
          # Process new releases from temp file
          if [ -s "$TEMP_RELEASES" ]; then
            while IFS='|' read -r TITLE LINK DATE; do
              # Prepare issue title and body by replacing placeholders
              ISSUE_TITLE="${ISSUE_TITLE_TEMPLATE//\{version\}/$TITLE}"
              ISSUE_BODY="${ISSUE_BODY_TEMPLATE//\{version\}/$TITLE}"
              ISSUE_BODY="${ISSUE_BODY//\{date\}/$DATE}"
              ISSUE_BODY="${ISSUE_BODY//\{url\}/$LINK}"
              
              # Create GitHub issue
              echo "Creating issue for release: $TITLE"
              gh issue create \
                --title "$ISSUE_TITLE" \
                --body "$ISSUE_BODY" \
                --label "$ISSUE_LABELS"
              
              # Add release to notified list
              echo "$TITLE" >> "$NOTIFIED_FILE"
            done < "$TEMP_RELEASES"
            
            # Commit and push the updated notified releases file
            git add "$NOTIFIED_FILE"
            git commit -m "Track notified releases: $(wc -l < "$TEMP_RELEASES") new release(s)"
            
            # Push with retry logic
            PUSH_RETRIES=3
            PUSH_SUCCESS=false
            for i in $(seq 1 $PUSH_RETRIES); do
              if git push; then
                PUSH_SUCCESS=true
                break
              else
                echo "Push failed (attempt $i/$PUSH_RETRIES), retrying in 5 seconds..."
                sleep 5
                git pull --rebase
              fi
            done
            
            if [ "$PUSH_SUCCESS" = false ]; then
              echo "Error: Failed to push changes after $PUSH_RETRIES attempts"
              echo "Issues were created but tracking file was not updated"
              echo "Manual intervention may be required to update .github/notified-releases/releases.txt"
              exit 1
            fi
            
            echo "Successfully notified $(wc -l < "$TEMP_RELEASES") new release(s) and updated tracker"
          else
            echo "No new releases to notify"
          fi
          
          # Cleanup
          rm -f "$TEMP_RELEASES"
